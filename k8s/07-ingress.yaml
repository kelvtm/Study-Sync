# ============================================
# Ingress: External HTTP/HTTPS Access
# ============================================
#
# CONCEPT: Ingress manages external access to Services
# Think of it as a "smart router" or "reverse proxy"
#
# WHY INGRESS?
# Without Ingress:
# - Need LoadBalancer Service for each app (expensive!)
# - Each Service gets separate public IP
#
# With Ingress:
# - Single entry point for entire cluster
# - Route based on hostname and path
# - SSL/TLS termination
# - Cost-effective (one load balancer)
#
# REAL-WORLD ANALOGY:
# - Services = Offices in a building (internal)
# - Ingress = Building reception desk (external)
# - Routes visitors to correct office based on request
# ============================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: studysync-ingress
  namespace: studysync-dev
  labels:
    app: studysync
  annotations:
    # Ingress class (controller to use)
    kubernetes.io/ingress.class: "nginx"

    # CORS (if needed)
    # nginx.ingress.kubernetes.io/enable-cors: "true"
    # nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    # nginx.ingress.kubernetes.io/cors-allow-origin: "*"

    # WebSocket support (for Socket.IO)
    nginx.ingress.kubernetes.io/websocket-services: "studysync-backend"

    # Request size limits
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"

    # Rate limiting (optional)
    # nginx.ingress.kubernetes.io/limit-rps: "100"

    # SSL redirect (enable when you have SSL cert)
    # nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  # ============================================
  # INGRESS RULES: Define routing
  # ============================================
  rules:
    - host: studysync.local # Local development domain
      http:
        paths:
          # Backend API routes
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 3000

          # Socket.IO WebSocket routes
          - path: /socket.io
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 3000

          # Frontend (catch-all for SPA)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: studysync-frontend
                port:
                  number: 80

  # ============================================
  # TLS/SSL Configuration (for HTTPS)
  # ============================================
  # tls:
  # - hosts:
  #   - studysync.local
  #   secretName: studysync-tls-cert

  # LEARNING NOTE: TLS Certificate
  # Create with:
  # kubectl create secret tls studysync-tls-cert \
  #   --cert=path/to/cert.pem \
  #   --key=path/to/key.pem \
  #   -n studysync-dev

# ============================================
# PATH TYPES EXPLAINED:
# ============================================
#
# Prefix: Match prefix of path
#   /api → matches /api, /api/users, /api/login
#
# Exact: Match exact path only
#   /api → matches /api only, NOT /api/users
#
# ImplementationSpecific: Controller-specific
#   Depends on Ingress controller implementation
# ============================================

# ============================================
# HOW ROUTING WORKS:
# ============================================
#
# Request Flow:
# 1. User → http://studysync.local/api/users
# 2. DNS resolves studysync.local to Minikube IP
# 3. Request hits Ingress Controller
# 4. Ingress checks rules:
#    - Host matches: studysync.local ✓
#    - Path matches: /api ✓
# 5. Routes to: studysync-backend:3000
# 6. Service load balances to backend Pods
# 7. Pod processes request
# 8. Response flows back
# ============================================

# ============================================
# COMMANDS:
# ============================================
#
# Apply Ingress:
#   kubectl apply -f 07-ingress.yaml
#
# List Ingresses:
#   kubectl get ingress -n studysync-dev
#   kubectl get ing -n studysync-dev  # Short form
#
# Describe Ingress:
#   kubectl describe ingress studysync-ingress -n studysync-dev
#
# View Ingress details:
#   kubectl get ingress studysync-ingress -n studysync-dev -o yaml
#
# Get Ingress address:
#   kubectl get ingress studysync-ingress -n studysync-dev \
#     -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
#
# Delete Ingress:
#   kubectl delete ingress studysync-ingress -n studysync-dev
# ============================================

# ============================================
# SETUP INGRESS CONTROLLER (First Time Only):
# ============================================
#
# Minikube: Enable Ingress addon
#   minikube addons enable ingress
#
# Verify Ingress Controller running:
#   kubectl get pods -n ingress-nginx
#
# Get Minikube IP:
#   minikube ip
#
# Add to hosts file (C:\Windows\System32\drivers\etc\hosts):
#   <minikube-ip> studysync.local
#
# Example:
#   192.168.49.2 studysync.local
# ============================================

# ============================================
# TESTING INGRESS:
# ============================================
#
# Test from outside cluster:
#   curl http://studysync.local/api/health
#   curl http://studysync.local/
#
# Or in browser:
#   http://studysync.local
#   http://studysync.local/api/health
# ============================================

# ============================================
# ADVANCED: Multiple Ingresses
# ============================================
# You can have multiple Ingress resources:
# - One per subdomain
# - One per environment
# - Different controllers (nginx, traefik, etc.)
# ============================================

---
# ============================================
# Alternative: Separate Ingresses per Service
# ============================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: studysync-backend-ingress
  namespace: studysync-dev
  annotations:
    kubernetes.io/ingress.class: "nginx"
spec:
  rules:
    - host: api.studysync.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: studysync-backend
                port:
                  number: 3000

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: studysync-frontend-ingress
  namespace: studysync-dev
  annotations:
    kubernetes.io/ingress.class: "nginx"
spec:
  rules:
    - host: app.studysync.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: studysync-frontend
                port:
                  number: 80
# ============================================
# LEARNING NOTE: Multiple Ingresses
# Useful for:
# - api.yourdomain.com → Backend
# - app.yourdomain.com → Frontend
# - admin.yourdomain.com → Admin panel
# ============================================
