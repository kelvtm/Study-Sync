# Prometheus & Grafana Configuration
# This uses the kube-prometheus-stack which includes:
# - Prometheus Operator
# - Prometheus
# - Alertmanager
# - Grafana
# - Node Exporter
# - Kube State Metrics

# ==============================================
# Prometheus Configuration
# ==============================================
prometheus:
  prometheusSpec:
    # Retention period for metrics
    retention: 7d #reduced from 30d

    # Storage configuration
    # storageSpec:
    #   volumeClaimTemplate:
    #     spec:
    #       storageClassName: gp2 # AWS EBS storage class
    #       accessModes: ["ReadWriteOnce"]
    #       resources:
    #         requests:
    #           storage: 50Gi

    # Resource limits
    resources:
      requests:
        cpu: 200m # Reduced from 500m
        memory: 512Mi # Reduced from 2Gi
      limits:
        cpu: 1000m # Reduced from 2000m
        memory: 1Gi # Reduced from 4Gi

    # Service Monitor selector - monitors all ServiceMonitors
    serviceMonitorSelectorNilUsesHelmValues: false

    # Pod Monitor selector
    podMonitorSelectorNilUsesHelmValues: false

    # Additional scrape configs for custom applications
    additionalScrapeConfigs:
      # Backend application metrics (if you add Prometheus client)
      - job_name: "studysync-backend"
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - production
                - staging
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: studysync-backend
          - source_labels:
              [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels:
              [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__

# ==============================================
# Grafana Configuration
# ==============================================
grafana:
  enabled: true

  # Admin credentials
  adminPassword: "admin123" # Change this in production!

  # Persistence for dashboards
  persistence:
    enabled: false
    storageClassName: gp2
    size: 10Gi

  # Resources
  resources:
    requests:
      cpu: 100m # Reduced from 250m
      memory: 256Mi # Reduced from 512Mi
    limits:
      cpu: 200m # Reduced from 500m
      memory: 512Mi # Reduced from 1Gi
  # Service configuration
  service:
    type: LoadBalancer # Creates AWS ELB for external access
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb" # Network Load Balancer

  # # Data sources - Prometheus is automatically configured
  # datasources:
  #   datasources.yaml:
  #     apiVersion: 1
  #     datasources:
  #       - name: Prometheus
  #         type: prometheus
  #         url: http://{{ include "kube-prometheus-stack.fullname" . }}-prometheus.{{ .Release.Namespace }}:9090
  #         access: proxy
  #         isDefault: true

  # Pre-installed dashboards
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: "default"
          orgId: 1
          folder: ""
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default

  # Import popular community dashboards
  dashboards:
    default:
      # Kubernetes cluster monitoring dashboard
      kubernetes-cluster:
        gnetId: 7249
        revision: 1
        datasource: Prometheus

      # Node exporter dashboard
      node-exporter:
        gnetId: 1860
        revision: 31
        datasource: Prometheus

      # Pod monitoring dashboard
      kubernetes-pods:
        gnetId: 6417
        revision: 1
        datasource: Prometheus

      # Nginx ingress controller (if you use it)
      nginx-ingress:
        gnetId: 9614
        revision: 1
        datasource: Prometheus

# ==============================================
# Alertmanager Configuration
# ==============================================
alertmanager:
  enabled: true

  alertmanagerSpec:
    # storage:
    #   volumeClaimTemplate:
    #     spec:
    #       storageClassName: gp2
    #       accessModes: ["ReadWriteOnce"]
    #       resources:
    #         requests:
    #           storage: 10Gi

    resources:
      requests:
        cpu: 50m # Reduced from 100m
        memory: 64Mi # Reduced from 128Mi
      limits:
        cpu: 100m # Reduced from 200m
        memory: 128Mi # Reduced from 256Mi

  # Alert configuration (you can customize this)
  config:
    global:
      resolve_timeout: 5m

    route:
      group_by: ["alertname", "cluster", "service"]
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: "null" # Change to your receiver (email, slack, etc.)
      routes:
        - match:
            alertname: Watchdog
          receiver: "null"

    receivers:
      - name: "null"

# ==============================================
# Node Exporter (collects node metrics)
# ==============================================
nodeExporter:
  enabled: true

# ==============================================
# Kube State Metrics (collects K8s object metrics)
# ==============================================
kubeStateMetrics:
  enabled: true

# ==============================================
# Prometheus Operator
# ==============================================
prometheusOperator:
  enabled: true

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# ==============================================
# Default Rules (pre-configured alerts)
# ==============================================
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: true
    configReloaders: true
    general: true
    k8s: true
    kubeApiserver: true
    kubeApiserverAvailability: true
    kubeApiserverSlos: true
    kubelet: true
    kubeProxy: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeScheduler: true
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true
