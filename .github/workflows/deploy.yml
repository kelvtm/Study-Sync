name: CI/CD Pipeline

permissions:
  contents: read # Required to checkout the code
  security-events: write #

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: studysync-cluster
  BACKEND_IMAGE: kelvtmoni/studysync-backend
  FRONTEND_IMAGE: kelvtmoni/studysync-frontend
  TEST_PORT: 3001

jobs:
  # ============================================
  # Job 1: Run Backend Tests
  # ============================================
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: ./backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Start test server
        env:
          NODE_ENV: test
          PORT: ${{ env.TEST_PORT }}
          MONGO_URI: ${{ secrets.MONGO_TEST_URI }}
        run: |
          echo "ðŸš€ Starting test server on port ${TEST_PORT}..."
          node server.js > test-server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > test-server.pid
          echo "ðŸ“ Server PID: $SERVER_PID"

          echo "â³ Waiting for test server to be ready..."
          COUNTER=0
          MAX_WAIT=30

          while [ $COUNTER -lt $MAX_WAIT ]; do
            if curl -s http://localhost:${TEST_PORT}/api/health > /dev/null 2>&1; then
              echo "âœ… Test server is ready!"
              break
            fi
            
            COUNTER=$((COUNTER + 1))
            
            if [ $COUNTER -eq $MAX_WAIT ]; then
              echo "âŒ Test server failed to start after ${MAX_WAIT} seconds"
              echo "ðŸ“‹ Server logs:"
              cat test-server.log
              exit 1
            fi
            
            echo "  Attempt $COUNTER/$MAX_WAIT - Server not ready yet..."
            sleep 1
          done

      - name: Run tests
        env:
          NODE_ENV: test
          PORT: ${{ env.TEST_PORT }}
          MONGO_URI: ${{ secrets.MONGO_TEST_URI }}
        run: npm test

      - name: Stop test server
        if: always()
        run: |
          if [ -f test-server.pid ]; then
            echo "ðŸ›‘ Stopping test server..."
            kill $(cat test-server.pid) 2>/dev/null || true
            rm test-server.pid
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            backend/test-server.log
            backend/coverage/
          retention-days: 7

  # ============================================
  # Job 2: Build Docker Images (without push)
  # ============================================
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: backend-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v6
        with:
          file: docker/Dockerfile.prod
          context: ./backend
          push: false
          load: true
          tags: ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v6
        with:
          file: docker/dockerfile.frontend.prod
          context: ./vue-project
          push: false
          load: true
          tags: ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Export Docker images
        run: |
          docker save ${{ env.BACKEND_IMAGE }}:${{ github.sha }} -o backend-image.tar
          docker save ${{ env.FRONTEND_IMAGE }}:${{ github.sha }} -o frontend-image.tar

      - name: Upload backend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend-image.tar
          retention-days: 1

      - name: Upload frontend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend-image.tar
          retention-days: 1

  # ============================================
  # Job 3: Trivy Security Scan - Backend
  # ============================================
  trivy-scan-backend:
    name: Trivy Scan - Backend
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Download backend image
        uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: Load Docker image
        run: docker load -i backend-image.tar

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          format: "sarif"
          output: "trivy-backend-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-backend-results.sarif"
          category: "trivy-backend"

      - name: Run Trivy with table output
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          format: "table"
          severity: "CRITICAL,HIGH"
          exit-code: "0" # Report only, don't fail build

      - name: Upload Trivy scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-backend-scan
          path: trivy-backend-results.sarif
          retention-days: 30

  # ============================================
  # Job 4: Trivy Security Scan - Frontend
  # ============================================
  trivy-scan-frontend:
    name: Trivy Scan - Frontend
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Download frontend image
        uses: actions/download-artifact@v4
        with:
          name: frontend-image

      - name: Load Docker image
        run: docker load -i frontend-image.tar

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          format: "sarif"
          output: "trivy-frontend-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-frontend-results.sarif"
          category: "trivy-frontend"

      - name: Run Trivy with table output
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          format: "table"
          severity: "CRITICAL,HIGH"
          exit-code: "0" # Report only, don't fail build

      - name: Upload Trivy scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-frontend-scan
          path: trivy-frontend-results.sarif
          retention-days: 30

  # ============================================
  # Job 5: Push Docker Images (only after scans pass)
  # ============================================
  docker-push:
    name: Push Docker Images
    runs-on: ubuntu-latest
    needs: [trivy-scan-backend, trivy-scan-frontend]

    steps:
      - name: Download backend image
        uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: Download frontend image
        uses: actions/download-artifact@v4
        with:
          name: frontend-image

      - name: Load Docker images
        run: |
          docker load -i backend-image.tar
          docker load -i frontend-image.tar

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag and push backend images
        run: |
          docker tag ${{ env.BACKEND_IMAGE }}:${{ github.sha }} ${{ env.BACKEND_IMAGE }}:latest
          docker push ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          docker push ${{ env.BACKEND_IMAGE }}:latest

      - name: Tag and push frontend images
        run: |
          docker tag ${{ env.FRONTEND_IMAGE }}:${{ github.sha }} ${{ env.FRONTEND_IMAGE }}:latest
          docker push ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          docker push ${{ env.FRONTEND_IMAGE }}:latest

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Image" >> $GITHUB_STEP_SUMMARY
          echo "- Latest: \`${{ env.BACKEND_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: \`${{ env.BACKEND_IMAGE }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Image" >> $GITHUB_STEP_SUMMARY
          echo "- Latest: \`${{ env.FRONTEND_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: \`${{ env.FRONTEND_IMAGE }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All security scans passed!" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 6: Deploy to EKS (optional)
  # ============================================
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: docker-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Deploy to Kubernetes
        run: |
          # Update your deployment files with new image tags
           kubectl set image deployment/backend-deployment backend=${{ env.BACKEND_IMAGE }}:${{ github.sha }} -n studysync-prod
           kubectl set image deployment/frontend-deployment frontend=${{ env.FRONTEND_IMAGE }}:${{ github.sha }} -n studysync-prod
           kubectl rollout status deployment/backend -n studysync-prod
           kubectl rollout status deployment/frontend -n studysync-prod
           echo "Add your deployment commands here"
